name: Update Weather Data

on:
  schedule:
    # Run every 4 hours (6 times per day)
    # Times in UTC - PVR is UTC-6
    # 08:00 UTC = 2:00 AM PVR
    # 12:00 UTC = 6:00 AM PVR
    # 16:00 UTC = 10:00 AM PVR
    # 20:00 UTC = 2:00 PM PVR
    # 00:00 UTC = 6:00 PM PVR
    # 04:00 UTC = 10:00 PM PVR
    - cron: '0 0,4,8,12,16,20 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  update-weather:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch Weather Data (Open-Meteo)
        run: |
          # Fetch 8 days of forecast data from Open-Meteo
          # Puerto Vallarta Coordinates: Lat 20.6534, Lon -105.2253
          # Current: temp, humidity, apparent_temp, weather_code, wind_speed
          # Daily: weather_code, temp_max, temp_min
          curl -s "https://api.open-meteo.com/v1/forecast?latitude=20.6534&longitude=-105.2253&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,wind_speed_10m&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=America%2FMexico_City&forecast_days=8" > weather_openmeteo.json
          
          if ! jq empty weather_openmeteo.json 2>/dev/null; then
            echo "Error: Invalid JSON received from Open-Meteo"
            exit 1
          fi
          
          # We'll keep the same filenames but use the new data source structure
          # For compatibility during transition, we overwrite weather.json and weather-es.json
          # but they will now have Open-Meteo structure.
          cp weather_openmeteo.json weather.json
          cp weather_openmeteo.json weather-es.json

      - name: Commit and Push Changes
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          git add weather.json weather-es.json
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update weather data (Open-Meteo) - $(date -u '+%Y-%m-%d %H:%M UTC')"
            git push
            echo "Weather data updated and pushed"
          fi
